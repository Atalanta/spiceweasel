#!/usr/bin/env ruby

require 'mixlib/cli'
require 'yaml'
 
class SpiceweaselCLI
  include Mixlib::CLI

  option :help,
  :short => "-h",
  :long => "--help",
  :description => "Show this message",
  :on => :tail,
  :boolean => true,
  :show_options => true,
  :exit => 0

  option :version,
  :short => "-v",
  :long => "--version",
  :description => "Version",
  :boolean => true,
  :proc => lambda {|v| 
    puts "Spiceweasel: 0.2"
    exit 0
  },
  :show_options => true

  banner("Usage: spiceweasel [option] file")

end

begin
  ARGV << "-h" if ARGV.empty? 
  cli = SpiceweaselCLI.new
  cli.parse_options
rescue OptionParser::InvalidOption => e 
  STDERR.puts e.message
  cli.parse_options(["-h"])
  exit(-1)
end

yml = YAML.load_file ARGV[0]
knife = ""

#cookbooks 
cookbooks = yml['cookbooks'] || []
cookbooks.each do |cookbook|
  knife += "knife cookbook upload #{cookbook}\n"
end

#roles 
roles = yml['roles'] || []
roles.each do |role|
  knife += "knife role from file #{role}.rb\n"
end

#data bags
bags = yml['data bags'] || []
bags.keys.each do |bag|
  knife += "knife data bag create #{bag}\n"
  items = bags[bag] || []
  items.each do |item|
    knife += "knife data bag from file #{bag} data_bags/#{item}.json\n"
  end
end

nodes = yml['nodes'] || []
nodes.keys.each do |node|
  run_list = nodes[node][0].split()
  #TODO verify the run_list against the nodes and recipes
  if node.start_with?("bluebox","ec2","rackspace","slicehost","terremark")
    provider = node.split()
    count = 1
    if (provider.length == 2)
      count = provider[1] 
    end
    count.to_i.times do
      knife += "knife #{provider[0]} server create "
      run_list.each do |x|
        knife += "\'#{x}\' "
      end
      knife +="#{nodes[node][1]}\n"
    end
  else
    knife += "knife bootstrap #{node} "
    run_list.each do |x|
      knife += "\'#{x}\' "
    end
    knife +="#{nodes[node][1]}\n"
  end
end

puts knife
#--clientsync
#--delete
#--dryrun 
#--rebuild
#remember to -y
